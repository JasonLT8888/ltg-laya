!function(e){var t={};function i(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)i.d(s,o,function(t){return e[t]}.bind(null,o));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=12)}([function(e,t){e.exports=require("path")},function(e,t){e.exports=require("process")},function(e,t){e.exports=require("fs")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.NotExist=0]="NotExist",e[e.Dir=1]="Dir",e[e.File=2]="File"}(t.EFileType||(t.EFileType={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(2),o=i(0),l=i(6),r=i(7),n=i(3),a=i(5);class c{static CompressJs(e,t){let i=s.statSync(e),r=o.win32.basename(e),n=s.readFileSync(e,{encoding:"utf-8"}),a=l.minify(n);if(a.error)throw console.error("压缩文件",r,"出错",a.error),SyntaxError("文件压缩失败,中断发包");this.WriteStrTo(t,a.code);let c=s.statSync(t),h=i.size/1024,p=c.size/1024,u=p/h,f="("+(100*u).toFixed(2)+"%)";return console.log("压缩",r.green,h.toFixed(2)+"Kb >>>>>>>> "+p.toFixed(2)+"Kb "+(u>1?f.red:f.green)),a.code}static WrapToES5(e){let t=r.execSync("babel ");console.log(t)}static ReplaceAll(e,t,i){let s=e;for(;s.indexOf(t)>=0;)s=s.replace(t,i);return s}static MakeDirExist(e){let t=null;return s.existsSync(e)&&(t=s.statSync(e)),!(!t||!t.isDirectory())||(s.mkdirSync(e,{recursive:!0}),!(!s.existsSync(e)||!s.statSync(e).isDirectory()))}static IsFileOrDir(e){if(!s.existsSync(e))return n.EFileType.NotExist;return s.statSync(e).isFile()?n.EFileType.File:n.EFileType.Dir}static DeleteDir(e){let t=[];if(s.existsSync(e)){t=s.readdirSync(e);for(let i=0;i<t.length;++i){let l=t[i],r=o.join(e,l);s.statSync(r).isDirectory()?this.DeleteDir(r):s.unlinkSync(r)}s.rmdirSync(e)}}static CopyFile(e,t){let i=t.lastIndexOf("\\"),o=t.substring(0,i);c.MakeDirExist(o),s.copyFileSync(e,t)}static CopyDir(e,t,i=null){this.MakeDirExist(t);let l=s.readdirSync(e);for(let r=0;r<l.length;++r){let n=l[r];if(i&&!i(n))continue;let a=o.join(e,n),c=o.join(t,n);s.statSync(a).isDirectory()?this.CopyDir(a,c,i):s.copyFileSync(a,c)}}static ReadStrFrom(e){if(!c.IsFileExist(e))return null;return s.statSync(e).isDirectory()?null:s.readFileSync(e,{encoding:"utf-8"})}static IsFileExist(e){return s.existsSync(e)}static GetDirName(e){let t=this.IsFileOrDir(e);if(t==n.EFileType.NotExist)return"";let i=(e=a.default.ReplaceAll(e,"\\","/")).split("/");return e.endsWith("/")||t==n.EFileType.File?i[i.length-2]:i[i.length-1]}static WriteStrTo(e,t){let i=e.lastIndexOf("\\"),o=e.substring(0,i);c.MakeDirExist(o),s.writeFileSync(e,t,{encoding:"utf-8"})}}t.LTUtils=c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{static ReplaceAll(e,t,i){for(;e.indexOf(t)>=0;)e=e.replace(t,i);return e}static IsNullOrEmpty(e){return null==e||""==e}}},function(e,t){e.exports=require("uglify-es")},function(e,t){e.exports=require("child_process")},,,,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(1),o=i(13);new class{constructor(){let e=this._GetParam("-p");if(null==e)return void console.log("需要传入-p 平台参数");let t="true"==this._GetParam("-c");new o.PublishHandler(e,t).Start()}_GetParam(e){let t=s.argv.indexOf(e);return t<0?null:s.argv[t+1]}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(0),o=i(2),l=i(1),r=i(14),n=i(4),a=i(15),c=i(5);t.PublishHandler=class{constructor(e,t=!0){this._keepPlatforms={wx:["project.config.json"],tt:["project.config.json"],qq:["project.config.json"]},this._platformStr=e,this._useCompress=t}Start(){let e=Date.now();console.log("开始发布",r.green(this._platformStr)),this._InitAll(),this._CheckRelease(),this._CopyTemplate(),this._CopyBin(),console.log(("注意cdn资源,需要拷贝到服务器:"+this._cdnPath).bgRed);let t=((Date.now()-e)/1e3).toFixed(2);console.log("发布完成",this._releasePath.green),console.log("总共耗时 "+t.green+" 秒")}_CopyBin(){let e=s.join(this._releasePath,"./res/");n.LTUtils.DeleteDir(e);let t=s.join(this._binPath,"./res/"),i=s.join(this._cdnPath,"./res/"),o=new a.SubpackHelper(t,this._packConfig);o.single_max_size=1024*this._packConfig.maxSinglePackSize*1024,o.total_max_size=1024*this._packConfig.maxTotalPackSize*1024,o.Analyze(),o.Replace(e,i),this._CopyIndex(),console.log("bin目录拷贝完成"),console.log()}_CopyIndex(){let e=s.join(this._binPath,"./index.js"),t=n.LTUtils.ReadStrFrom(e);if(this._useCompress){console.log("当前配置需要压缩js,开始压缩");var i=Date.now()}let l=s.join(this._workPath,"./temp/"+this._platformStr+"/");n.LTUtils.MakeDirExist(l);let r,a=/loadLib\("(.*)"\)/gm,c=t;for(;null!==(r=a.exec(c));)if(r.index===a.lastIndex&&a.lastIndex++,r[1]){let e=r[1],t=s.join(this._binPath,e),i=s.join(this._releasePath,e),a=i.lastIndexOf("\\"),c=i.substring(0,a);n.LTUtils.MakeDirExist(c),this._useCompress?this._DoCacheCompress(e,t,l,i):o.copyFileSync(t,i)}let h=s.join(this._releasePath,"./index.js");if(this._useCompress){this._DoCacheCompress("index.js",e,l,h);let t=((Date.now()-i)/1e3).toFixed(2);console.log("压缩完成,总共耗时 "+t.green+" 秒")}else o.copyFileSync(e,h),console.log("当前配置无需压缩,直接拷贝所有js文件")}_DoCacheCompress(e,t,i,l){let r=o.statSync(t).mtimeMs,a=s.join(i,e),h=n.LTUtils.ReadStrFrom(a);if(c.default.IsNullOrEmpty(h)){let i={fileName:e,modifyTime:r,compressJs:n.LTUtils.CompressJs(t,l)},s=JSON.stringify(i);n.LTUtils.WriteStrTo(a,s)}else{let i=JSON.parse(h),s=i.fileName,o=i.modifyTime;if(e==s&&o==r)console.log("文件未变动,直接使用缓存文件进行替换",e.green),n.LTUtils.WriteStrTo(l,i.compressJs);else{let i={fileName:e,modifyTime:r,compressJs:n.LTUtils.CompressJs(t,l)},s=JSON.stringify(i);n.LTUtils.WriteStrTo(a,s)}}}_CopyTemplate(){n.LTUtils.CopyDir(this._templatePath,this._releasePath,e=>{if(this._keepFiles.indexOf(e)>=0){let t=s.join(this._releasePath,e);if(o.existsSync(t))return console.log("检测到已存在",e.green,"进行保留"),!1}return!0}),console.log("template拷贝完成"),console.log()}_CheckRelease(){if(!n.LTUtils.MakeDirExist(this._releasePath))throw console.log("release路径检查","失败".red),SyntaxError("release路径创建失败,请检查权限");console.log("release路径检查","通过".green),console.log()}_InitAll(){this._workPath=l.cwd();let e=s.join(this._workPath,"./pack_config/publish."+this._platformStr+".json");n.LTUtils.IsFileExist(e)||(console.log("当前平台",this._platformStr,"不存在打包配置文件",e.red,"读取默认配置"),e=s.join(this._workPath,"./others/config/publish.default.json"));let t=n.LTUtils.ReadStrFrom(e);this._packConfig=JSON.parse(t),this._useCompress=this._packConfig.compress,this._releasePath=s.join(this._workPath,"./release/"+this._platformStr),this._templatePath=s.join(this._workPath,"./others/publish/templates/"+this._platformStr),this._binPath=s.join(this._workPath,"./bin/"),this._cdnPath=s.join(this._workPath,"./cdn/"+this._platformStr),console.log("release路径",this._releasePath.green),this._keepFiles=this._keepPlatforms[this._platformStr],this._keepFiles||(console.log("当前平台未配置keepFiles",this._platformStr),this._keepFiles=[]),console.log()}}},function(e,t){e.exports=require("colors")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(2),o=i(0),l=i(16),r=i(4),n=i(17);t.SubpackHelper=class{constructor(e,t){this.single_max_size=4194304,this.total_max_size=4194304,this._rootPath=e,this._packConfig=t,this._rootNode=new l.LTPackNode,this._rootNode.fullPath=e,this._rootNode.isNode=!1}Analyze(){this._AnalyzeDir(this._rootPath,this._rootNode),this._CombieNode(this._rootNode);let e=Math.ceil(this._rootNode.size/1024),t=e/1024;console.log("资源包:",this._rootNode.fullPath,"总共",e.toFixed(0)+"kb ("+t.toFixed(2)+"mb)"),this._subpacks=[],this._remoteFiles=[],this._cacheSize=0;let i=o.join(this._rootPath,"./../");for(let e=0;e<this._packConfig.forceInPack.length;++e){let t=this._packConfig.forceInPack[e],r=o.join(i,t);console.log("强制主包",r.green);let n=new l.LTPackNode;n.isNode=!1;let a=s.statSync(r);n.size=a.size,n.fullPath=r,this._subpacks.push(n),this._cacheSize+=n.size}this._SplitSubpack(this._rootNode,this._subpacks,this._remoteFiles),e=Math.ceil(this._cacheSize/1024),t=e/1024,console.log("拆分子包个数",this._subpacks.length,"总子包大小",e.toFixed(0)+"kb ("+t.toFixed(2)+"mb)")}Replace(e,t){r.LTUtils.DeleteDir(t);for(let e=0;e<this._remoteFiles.length;++e){let i=this._remoteFiles[e],s=i.fullPath.replace(this._rootPath,""),l=o.join(t,s);i.isNode?r.LTUtils.CopyFile(i.fullPath,l):r.LTUtils.CopyDir(i.fullPath,l)}r.LTUtils.DeleteDir(e);for(let t=0;t<this._subpacks.length;++t){let i=this._subpacks[t];if(i.isNode){console.log("子包检测到单文件,请注意检查".red,i.fullPath);continue}let l=i.fullPath.replace(this._rootPath,""),n=o.join(e,l);r.LTUtils.CopyDir(i.fullPath,n);let a=o.join(n,"./game.js");s.existsSync(a)||r.LTUtils.WriteStrTo(a,"")}let i=o.join(e,"./../game.json"),l=s.readFileSync(i,{encoding:"utf-8"}),a=JSON.parse(l),c=[],h=o.join(this._rootPath,"./../");for(let e=0;e<this._subpacks.length;++e){let t=this._subpacks[e];if(t.isNode)continue;let i=t.fullPath.replace(h,""),s=i.replace("\\","/");this._packConfig.packType==n.EPackResolveType.AutoSearch&&(this._packConfig.forceInPack.indexOf(s)>=0?console.log("强制主包",s.green):c.push({name:i,root:i}))}a.subpackages=c;let p=JSON.stringify(a);for(;p.indexOf("\\\\")>=0;)p=p.replace("\\\\","/");s.writeFileSync(i,p,{encoding:"utf-8"});let u=[];for(let e=0;e<this._subpacks.length;++e){let t=this._subpacks[e].fullPath.replace(h,""),i=r.LTUtils.ReplaceAll(t,"\\","/"),s=this._packConfig.packType==n.EPackResolveType.AllIn?1:2;this._packConfig.forceInPack.indexOf(i)>=0&&(s=1),u.push({path:i,pathType:s})}let f=o.join(e,"./../"),_=JSON.stringify(u),d=o.join(f,"./subpack.json");s.writeFileSync(d,_,{encoding:"utf-8"}),console.log("输出subpack.json",d)}_SplitSubpack(e,t,i){let s=o.join(this._rootPath,"./../");for(let o=0;o<e.childs.length;++o){let l=e.childs[o];if(l.isNode)i.push(l);else{let e=l.fullPath.replace(s,"");if(e=e.replace("\\","/"),!(this._packConfig.forceInPack.indexOf(e)>=0)){this._packConfig.forceRemote.indexOf(e)>=0||this._packConfig.packType==n.EPackResolveType.AllOut?(console.log("强制远程包",e.green),i.push(l)):l.size>this.single_max_size?this._SplitSubpack(l,t,i):l.size+this._cacheSize<this.total_max_size?(t.push(l),this._cacheSize+=l.size):this._SplitSubpack(l,t,i)}}}}_CombieNode(e){for(let t=0;t<e.childs.length;++t){let i=e.childs[t];i.isNode||this._CombieNode(i),e.size+=i.size}}_AnalyzeDir(e,t){let i=s.readdirSync(e);for(let r=0;r<i.length;++r){let n=i[r],a=o.join(e,n),c=s.statSync(a),h=new l.LTPackNode;h.fullPath=a,h.parent=t,t.childs.push(h),c.isDirectory()?(h.isNode=!1,this._AnalyzeDir(a,h)):(h.isNode=!0,h.size=c.size)}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.LTPackNode=class{constructor(){this.childs=[],this.size=0}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.AutoSearch=0]="AutoSearch",e[e.AllIn=1]="AllIn",e[e.AllOut=2]="AllOut"}(t.EPackResolveType||(t.EPackResolveType={}))}]);